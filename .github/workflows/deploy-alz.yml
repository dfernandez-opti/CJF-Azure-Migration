name: Deploy Azure Landing Zone (ALZ) - CJF

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      subscription_id:
        description: 'Azure Subscription ID'
        required: true
        type: string
  push:
    branches:
      - main
      - develop
    paths:
      - '3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
    paths:
      - '3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/**'
      - '.github/workflows/**'

env:
  AZURE_SUBSCRIPTION_ID: ${{ github.event.inputs.subscription_id || secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  RESOURCE_GROUP_NAME: 'rg-cjf-alz-deployment'
  LOCATION: 'eastus'

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Secret Scanning
        if: github.event_name != 'workflow_dispatch'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before || github.event.repository.default_branch }}
          head: ${{ github.event.after || github.sha }}
          only_verified: false
      
      - name: Run Secret Scanning (Manual Trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          only_verified: false

      - name: Upload Security Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            codeql-results/
            secret-scan-results/
            arm-ttk-results/
          retention-days: 90

  arm-template-linter:
    name: ARM Template Linter
    runs-on: windows-latest
    needs: security-scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run ARM Template Linter
        shell: pwsh
        run: |
          $armTtkPath = "$env:RUNNER_TEMP\arm-ttk"
          git clone https://github.com/Azure/arm-ttk.git $armTtkPath
          $modulePath = Join-Path $armTtkPath "arm-ttk.psd1"
          if (-not (Test-Path $modulePath)) {
            $modulePath = Get-ChildItem $armTtkPath -Recurse -Filter "*.psd1" | Select-Object -First 1 -ExpandProperty FullName
          }
          if ($modulePath -and (Test-Path $modulePath)) {
            Import-Module $modulePath -Force
            Test-AzTemplate -TemplatePath 3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Template.json -Skip Parameter-File-Should-Exist,DeploymentTemplate-Must-Be-Present -Verbose
          } else {
            Write-Host "Error: Could not find arm-ttk module file"
            Get-ChildItem $armTtkPath | Select-Object Name, FullName | Format-Table
            exit 1
          }

      - name: Upload ARM TTK Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: arm-ttk-results
          path: |
            arm-ttk-results/
          retention-days: 90

  validate-templates:
    name: Validate ARM Templates
    runs-on: ubuntu-latest
    needs: [security-scan, arm-template-linter]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate ARM Template
        run: |
          TEMPLATE_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Template.json"
          PARAMETERS_FILE="3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Parameters.json"
          az deployment sub validate \
            --location ${{ env.LOCATION }} \
            --template-uri $TEMPLATE_URL \
            --parameters @$PARAMETERS_FILE

      - name: Export Validation Results
        run: |
          echo "## ARM Template Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "Template validation successful" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY

  deploy-alz:
    name: Deploy ALZ
    runs-on: ubuntu-latest
    needs: [security-scan, validate-templates]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
          az account show

      - name: Create Resource Group (if not exists)
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP_NAME }} \
            --location ${{ env.LOCATION }} \
            --tags Environment=${{ github.event.inputs.environment || 'production' }} \
                   Project='CJF-ALZ' \
                   ManagedBy='GitHubActions' \
                   DeploymentDate=$(date -u +"%Y-%m-%d")

      - name: Deploy ALZ Template
        id: deploy
        run: |
          DEPLOYMENT_NAME="alz-deployment-$(date +%s)"
          TEMPLATE_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Template.json"
          PARAMETERS_FILE="3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Parameters.json"
          az deployment sub create \
            --name $DEPLOYMENT_NAME \
            --location ${{ env.LOCATION }} \
            --template-uri $TEMPLATE_URL \
            --parameters @$PARAMETERS_FILE \
            --verbose
          
          echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT
          echo "deployment_timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Get Deployment Status
        run: |
          az deployment sub show \
            --name ${{ steps.deploy.outputs.deployment_name }} \
            --query "{provisioningState:properties.provisioningState,correlationId:properties.correlationId,timestamp:properties.timestamp}" \
            --output json > deployment-status.json

      - name: Run Azure Landing Zone Review
        run: |
          # Install Azure CLI extension for ALZ Review
          az extension add --name alz-review || az extension update --name alz-review
          
          # Run ALZ Review assessment
          az alz review \
            --subscription-id ${{ env.AZURE_SUBSCRIPTION_ID }} \
            --output-file alz-review-results.json \
            --output-format json
          
          # Convert to markdown for documentation
          cat alz-review-results.json | jq '.' > 3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Review-Assessment/azure-landing-zone-review-results.json

      - name: Generate Deployment Log
        run: |
          cat > 3.0-Manage-Optimize/3.1-Repeatable-Deployment/deployment-evidence/deployment-log-$(date +%Y%m%d-%H%M%S).md << EOF
          # ALZ Deployment Log - CJF
          
          **Deployment Date:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Deployment Name:** ${{ steps.deploy.outputs.deployment_name }}
          **Environment:** ${{ github.event.inputs.environment || 'production' }}
          **Workflow Run:** ${{ github.run_id }}
          **Commit SHA:** ${{ github.sha }}
          
          ## Deployment Status
          \`\`\`json
          $(cat deployment-status.json)
          \`\`\`
          
          ## Azure Landing Zone Review Results
          See: \`ALZ-Review-Assessment/azure-landing-zone-review-results.json\`
          
          ## Security Scans
          - CodeQL Analysis: Passed
          - Secret Scanning: Passed
          - ARM Template Validation: Passed
          
          ## Resources Deployed
          - Identity Management: Microsoft Entra ID
          - Networking: Hub & Spoke Architecture
          - Resource Organization: Tagging and Naming Standards
          EOF

      - name: Upload Deployment Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            3.0-Manage-Optimize/3.1-Repeatable-Deployment/deployment-evidence/
            3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Review-Assessment/
            deployment-status.json
          retention-days: 365

      - name: Export Policy Compliance
        run: |
          # Get Azure Policy compliance results
          az policy state list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --output json > policy-compliance-results.json
          
          # Upload as artifact
          echo "Policy compliance results exported"

      - name: Upload Policy Compliance Results
        uses: actions/upload-artifact@v4
        with:
          name: policy-compliance
          path: policy-compliance-results.json
          retention-days: 365

  generate-sbom:
    name: Generate Software Bill of Materials (SBOM)
    runs-on: ubuntu-latest
    needs: [security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 365

